// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © LakshyaP06

//@version=5
indicator("Advanced ASX Stock Prediction", overlay=true, max_bars_back=500)

// ═══════════════════════════════════════════════════════════════════════════════
// INPUT SETTINGS
// ═══════════════════════════════════════════════════════════════════════════════

// Moving Averages
emaShortLength = input.int(9, "EMA Short Length", minval=1, group="Moving Averages")
emaLongLength = input.int(21, "EMA Long Length", minval=1, group="Moving Averages")
smaLength = input.int(50, "SMA Length", minval=1, group="Moving Averages")
sma200Length = input.int(200, "SMA 200 Length", minval=1, group="Moving Averages")

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI")
rsiOverbought = input.int(70, "RSI Overbought", minval=50, maxval=100, group="RSI")
rsiOversold = input.int(30, "RSI Oversold", minval=0, maxval=50, group="RSI")

// MACD Settings
macdFast = input.int(12, "MACD Fast Length", minval=1, group="MACD")
macdSlow = input.int(26, "MACD Slow Length", minval=1, group="MACD")
macdSignal = input.int(9, "MACD Signal Length", minval=1, group="MACD")

// Bollinger Bands
bbLength = input.int(20, "Bollinger Bands Length", minval=1, group="Bollinger Bands")
bbMult = input.float(2.0, "Bollinger Bands Multiplier", minval=0.1, step=0.1, group="Bollinger Bands")

// ATR Settings
atrLength = input.int(14, "ATR Length", minval=1, group="ATR & Volatility")
atrMultiplier = input.float(1.5, "ATR Multiplier for Stops", minval=0.1, step=0.1, group="ATR & Volatility")

// Volume Settings
volumeMaLength = input.int(20, "Volume MA Length", minval=1, group="Volume")

// Prediction Settings
predictionStrength = input.int(60, "Prediction Signal Strength", minval=0, maxval=100, group="Prediction Settings")
showPredictionLabels = input.bool(true, "Show Prediction Labels", group="Prediction Settings")
showSupportResistance = input.bool(true, "Show Support/Resistance", group="Prediction Settings")

// ═══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Moving Averages
emaShort = ta.ema(close, emaShortLength)
emaLong = ta.ema(close, emaLongLength)
sma50 = ta.sma(close, smaLength)
sma200 = ta.sma(close, sma200Length)

// RSI
rsi = ta.rsi(close, rsiLength)

// MACD
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)

// Bollinger Bands
bbBasis = ta.sma(close, bbLength)
bbDev = bbMult * ta.stdev(close, bbLength)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

// ATR
atr = ta.atr(atrLength)

// Volume Analysis
volumeMa = ta.sma(volume, volumeMaLength)
volumeIncreasing = volume > volumeMa

// ADX for Trend Strength
[diPlus, diMinus, adx] = ta.dmi(14, 14)
strongTrend = adx > 25

// Stochastic
stochK = ta.stoch(close, high, low, 14)
stochD = ta.sma(stochK, 3)

// ═══════════════════════════════════════════════════════════════════════════════
// TREND ANALYSIS
// ═══════════════════════════════════════════════════════════════════════════════

// Primary Trend
uptrend = emaShort > emaLong and close > sma50
downtrend = emaShort < emaLong and close < sma50

// Long-term Trend
longTermBullish = close > sma200
longTermBearish = close < sma200

// Trend Changes
emaCrossUp = ta.crossover(emaShort, emaLong)
emaCrossDown = ta.crossunder(emaShort, emaLong)

// ═══════════════════════════════════════════════════════════════════════════════
// SIGNAL GENERATION
// ═══════════════════════════════════════════════════════════════════════════════

// Bullish Signals
bullishRsi = rsi < rsiOversold and rsi > rsi[1]
bullishMacd = ta.crossover(macdLine, signalLine)
bullishBB = close < bbLower and close > close[1]
bullishStoch = ta.crossover(stochK, stochD) and stochK < 20
bullishVolume = volumeIncreasing and close > open

// Bearish Signals
bearishRsi = rsi > rsiOverbought and rsi < rsi[1]
bearishMacd = ta.crossunder(macdLine, signalLine)
bearishBB = close > bbUpper and close < close[1]
bearishStoch = ta.crossunder(stochK, stochD) and stochK > 80
bearishVolume = volumeIncreasing and close < open

// Count Signals
bullishScore = (bullishRsi ? 20 : 0) + (bullishMacd ? 20 : 0) + (bullishBB ? 15 : 0) + 
               (bullishStoch ? 15 : 0) + (emaCrossUp ? 20 : 0) + (bullishVolume ? 10 : 0)

bearishScore = (bearishRsi ? 20 : 0) + (bearishMacd ? 20 : 0) + (bearishBB ? 15 : 0) + 
               (bearishStoch ? 15 : 0) + (emaCrossDown ? 20 : 0) + (bearishVolume ? 10 : 0)

// Final Prediction Signals
strongBuySignal = bullishScore >= predictionStrength and uptrend and strongTrend
buySignal = bullishScore >= predictionStrength and uptrend

strongSellSignal = bearishScore >= predictionStrength and downtrend and strongTrend
sellSignal = bearishScore >= predictionStrength and downtrend

// ═══════════════════════════════════════════════════════════════════════════════
// SUPPORT AND RESISTANCE
// ═══════════════════════════════════════════════════════════════════════════════

// Pivot Points (for ASX session)
pivotHigh = ta.pivothigh(high, 5, 5)
pivotLow = ta.pivotlow(low, 5, 5)

// Store support and resistance levels
var float resistance = na
var float support = na

if not na(pivotHigh)
    resistance := pivotHigh

if not na(pivotLow)
    support := pivotLow

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════════════════

// Moving Averages
plot(emaShort, "EMA Short", color=color.new(color.blue, 0), linewidth=2)
plot(emaLong, "EMA Long", color=color.new(color.orange, 0), linewidth=2)
plot(sma50, "SMA 50", color=color.new(color.purple, 0), linewidth=1)
plot(sma200, "SMA 200", color=color.new(color.gray, 0), linewidth=2)

// Bollinger Bands
p1 = plot(bbUpper, "BB Upper", color=color.new(color.teal, 70))
p2 = plot(bbLower, "BB Lower", color=color.new(color.teal, 70))
fill(p1, p2, color=color.new(color.teal, 90), title="BB Fill")

// Support and Resistance
plot(showSupportResistance ? resistance : na, "Resistance", color=color.new(color.red, 0), 
     linewidth=1, style=plot.style_circles)
plot(showSupportResistance ? support : na, "Support", color=color.new(color.green, 0), 
     linewidth=1, style=plot.style_circles)

// Buy/Sell Signals
plotshape(strongBuySignal, "Strong Buy", shape.labelup, location.belowbar, 
          color=color.new(color.green, 0), text="STRONG BUY", textcolor=color.white, size=size.normal)
plotshape(buySignal and not strongBuySignal, "Buy", shape.triangleup, location.belowbar, 
          color=color.new(color.lime, 0), text="BUY", textcolor=color.white, size=size.small)

plotshape(strongSellSignal, "Strong Sell", shape.labeldown, location.abovebar, 
          color=color.new(color.red, 0), text="STRONG SELL", textcolor=color.white, size=size.normal)
plotshape(sellSignal and not strongSellSignal, "Sell", shape.triangledown, location.abovebar, 
          color=color.new(color.orange, 0), text="SELL", textcolor=color.white, size=size.small)

// ATR-based Stop Loss levels
buyStopLevel = close - (atr * atrMultiplier)
sellStopLevel = close + (atr * atrMultiplier)

plot(strongBuySignal or buySignal ? buyStopLevel : na, "Buy Stop Loss", 
     color=color.new(color.red, 0), linewidth=1, style=plot.style_cross)
plot(strongSellSignal or sellSignal ? sellStopLevel : na, "Sell Stop Loss", 
     color=color.new(color.green, 0), linewidth=1, style=plot.style_cross)

// ═══════════════════════════════════════════════════════════════════════════════
// BACKGROUND COLORING
// ═══════════════════════════════════════════════════════════════════════════════

bgColor = uptrend and strongTrend ? color.new(color.green, 95) : 
          downtrend and strongTrend ? color.new(color.red, 95) : 
          color.new(color.gray, 98)
bgcolor(bgColor, title="Trend Background")

// ═══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

alertcondition(strongBuySignal, title="Strong Buy Alert", 
               message="Strong BUY signal detected! Score: {{plot_0}}")
alertcondition(buySignal, title="Buy Alert", 
               message="BUY signal detected! Score: {{plot_0}}")
alertcondition(strongSellSignal, title="Strong Sell Alert", 
               message="Strong SELL signal detected! Score: {{plot_0}}")
alertcondition(sellSignal, title="Sell Alert", 
               message="SELL signal detected! Score: {{plot_0}}")
alertcondition(emaCrossUp, title="Bullish EMA Cross", 
               message="Bullish EMA crossover detected")
alertcondition(emaCrossDown, title="Bearish EMA Cross", 
               message="Bearish EMA crossunder detected")

// ═══════════════════════════════════════════════════════════════════════════════
// TABLE - PREDICTION DASHBOARD
// ═══════════════════════════════════════════════════════════════════════════════

if showPredictionLabels
    var table dashboard = table.new(position.top_right, 2, 8, 
                                     bgcolor=color.new(color.black, 80), 
                                     border_width=2, border_color=color.gray)
    
    // Headers
    table.cell(dashboard, 0, 0, "Indicator", text_color=color.white, bgcolor=color.new(color.gray, 70))
    table.cell(dashboard, 1, 0, "Value", text_color=color.white, bgcolor=color.new(color.gray, 70))
    
    // RSI
    rsiColor = rsi > rsiOverbought ? color.red : rsi < rsiOversold ? color.green : color.yellow
    table.cell(dashboard, 0, 1, "RSI", text_color=color.white)
    table.cell(dashboard, 1, 1, str.tostring(math.round(rsi, 2)), text_color=rsiColor)
    
    // Trend
    trendText = uptrend ? "BULLISH" : downtrend ? "BEARISH" : "NEUTRAL"
    trendColor = uptrend ? color.green : downtrend ? color.red : color.yellow
    table.cell(dashboard, 0, 2, "Trend", text_color=color.white)
    table.cell(dashboard, 1, 2, trendText, text_color=trendColor)
    
    // ADX
    adxColor = adx > 25 ? color.green : color.orange
    table.cell(dashboard, 0, 3, "ADX", text_color=color.white)
    table.cell(dashboard, 1, 3, str.tostring(math.round(adx, 2)), text_color=adxColor)
    
    // Bullish Score
    table.cell(dashboard, 0, 4, "Bull Score", text_color=color.white)
    table.cell(dashboard, 1, 4, str.tostring(bullishScore), text_color=color.green)
    
    // Bearish Score
    table.cell(dashboard, 0, 5, "Bear Score", text_color=color.white)
    table.cell(dashboard, 1, 5, str.tostring(bearishScore), text_color=color.red)
    
    // Volume Status
    volStatus = volumeIncreasing ? "HIGH" : "LOW"
    volColor = volumeIncreasing ? color.green : color.gray
    table.cell(dashboard, 0, 6, "Volume", text_color=color.white)
    table.cell(dashboard, 1, 6, volStatus, text_color=volColor)
    
    // Long Term Trend
    ltTrend = longTermBullish ? "BULLISH" : "BEARISH"
    ltColor = longTermBullish ? color.green : color.red
    table.cell(dashboard, 0, 7, "LT Trend", text_color=color.white)
    table.cell(dashboard, 1, 7, ltTrend, text_color=ltColor)